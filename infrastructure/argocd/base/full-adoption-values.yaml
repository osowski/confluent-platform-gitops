# ArgoCD Helm Chart Base Configuration
# This configuration enables ArgoCD to manage itself (self-management pattern)
#
# IMPORTANT: This configuration assumes ArgoCD was initially installed manually via:
#   kubectl apply -n argocd --server-side --force-conflicts -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
#
# The Helm chart will take over management of existing resources but will NOT recreate secrets.
# This preserves admin passwords, Redis authentication, and other sensitive data.

global:
  # Domain configuration for ArgoCD UI
  domain: argocd.example.com  # Override in cluster overlay

# ArgoCD Configs - Core Secret Management
configs:
  secret:
    # DO NOT recreate argocd-secret - reuse existing secret from manual installation
    # This preserves the admin password, server secret key, and other sensitive data
    createSecret: false

# ArgoCD Server Configuration
server:
  # Add sync annotations to force recreation of Deployment with immutable selector
  deploymentAnnotations:
    argocd.argoproj.io/sync-options: "Force=true,Replace=true"
  # Enable ingress for ArgoCD UI
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      # Traefik-specific annotations for backend protocol
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
    tls: true

  # Configure ArgoCD server settings
  config:
    # Enable anonymous access (optional, can be disabled in overlay)
    # For production, consider OAuth or SSO
    url: https://argocd.example.com  # Override in cluster overlay

    # Resource customizations for better health checks
    resource.customizations.health.argoproj.io_Application: |
      hs = {}
      hs.status = "Progressing"
      hs.message = ""
      if obj.status ~= nil then
        if obj.status.health ~= nil then
          hs.status = obj.status.health.status
          if obj.status.health.message ~= nil then
            hs.message = obj.status.health.message
          end
        end
      end
      return hs

# ArgoCD Application Controller Configuration
controller:
  # Add sync annotations to force recreation
  statefulsetAnnotations:
    argocd.argoproj.io/sync-options: "Force=true,Replace=true"
  # Resource limits for the controller
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# ArgoCD Repo Server Configuration
repoServer:
  # Add sync annotations to force recreation
  deploymentAnnotations:
    argocd.argoproj.io/sync-options: "Force=true,Replace=true"
  # Resource limits for repo server
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# ArgoCD Redis Configuration
redis:
  # Add sync annotations to force recreation
  deploymentAnnotations:
    argocd.argoproj.io/sync-options: "Force=true,Replace=true"
  serviceAccount:
    create: true
    name: argocd-redis
  # Resource limits for Redis
  resources:
    limits:
      cpu: 200m
      memory: 128Mi
    requests:
      cpu: 100m
      memory: 64Mi

# Redis Secret Initialization
# IMPORTANT: Disabled to reuse existing argocd-redis secret from manual installation
# The manual install creates this secret via a Job, and we don't want to recreate it
redisSecretInit:
  enabled: false
  serviceAccount:
    name: argocd-redis-secret-init

# ArgoCD ApplicationSet Controller
applicationSet:
  enabled: true
  # Add sync annotations to force recreation
  deploymentAnnotations:
    argocd.argoproj.io/sync-options: "Force=true,Replace=true"
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# ArgoCD Notifications Controller
notifications:
  enabled: false  # Can be enabled in overlay if needed
  secret:
    create: false  # Reuse existing argocd-notifications-secret from manual installation

# ArgoCD Dex (SSO) - disabled by default
dex:
  enabled: false  # Can be enabled in overlay for SSO

## NOTES:
## - This configuration is optimized for homelab environments
## - Resource limits are conservative for small clusters
## - TLS is enabled but certificates should be managed by cert-manager
## - Override domain and URLs in cluster-specific overlays
